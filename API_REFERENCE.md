# API Reference

Complete reference for the Reply Platform Dashboard API client and type definitions.

## ðŸ“‹ Table of Contents

- [Overview](#overview)
- [API Client](#api-client)
- [Type Definitions](#type-definitions)
- [Authentication](#authentication)
- [Endpoints](#endpoints)
- [Error Handling](#error-handling)
- [Usage Examples](#usage-examples)

## Overview

The API client (`src/lib/api.ts`) provides a typed interface to the Reply Platform API backend. All API calls are made via HTTPS to the backend service running on Cloudflare Workers.

### Base Configuration

```typescript
const API_URL = process.env.NEXT_PUBLIC_API_URL || 
  'https://reply-platform-api.red-frog-895a.workers.dev';
```

**Environment Variables:**
- `NEXT_PUBLIC_API_URL`: API endpoint URL (required for production)

## API Client

The API client is exported as a singleton object with methods for each endpoint.

```typescript
import { api } from '@/lib/api';
```

## Type Definitions

### User

Represents a user account in the system.

```typescript
interface User {
  id: string;              // Unique user identifier
  email: string;           // User's email address
  name: string | null;     // User's display name (nullable)
  picture: string | null;  // Profile picture URL (nullable)
}
```

**Fields:**
- `id`: UUID generated by the backend
- `email`: Verified email from OAuth or registration
- `name`: Full name from OAuth profile (Google) or user input
- `picture`: Avatar URL from OAuth provider

### Website

Represents a website/domain registered for chatbot integration.

```typescript
interface Website {
  id: string;          // Unique website identifier
  user_id: string;     // Owner's user ID (foreign key)
  domain: string;      // Website domain/URL
  created_at: string;  // ISO 8601 timestamp
  updated_at: string;  // ISO 8601 timestamp
}
```

**Fields:**
- `id`: UUID generated by the backend
- `user_id`: Links website to owner
- `domain`: Full domain (e.g., "example.com" or "https://example.com")
- `created_at`: When the website was added
- `updated_at`: Last modification timestamp

### AuthResponse

Response from authentication endpoints.

```typescript
interface AuthResponse {
  token: string;  // JWT authentication token
  user: User;     // User object
}
```

**Fields:**
- `token`: JWT token for subsequent API calls (expires after 24 hours)
- `user`: Complete user object with profile information

## Authentication

### Methods

All authenticated endpoints require a JWT token in the `Authorization` header:

```typescript
headers: {
  Authorization: `Bearer ${token}`
}
```

### Token Management

Use the `auth` utility for token management:

```typescript
import { auth } from '@/lib/auth';

// Store token
auth.setToken(response.token);

// Retrieve token
const token = auth.getToken();

// Check authentication
if (auth.isAuthenticated()) {
  // User is logged in
}

// Logout
auth.removeToken();
```

## Endpoints

### POST /auth/google

Exchange Google OAuth authorization code for JWT token.

**Endpoint:** `POST /auth/google`

**Authentication:** Not required

**Request:**
```typescript
{
  code: string;        // OAuth authorization code from Google
  redirectUri: string; // Redirect URI used in OAuth flow
}
```

**Response:**
```typescript
{
  token: string;  // JWT token
  user: User;     // User object
}
```

**Method:**
```typescript
async auth(code: string, redirectUri: string): Promise<AuthResponse>
```

**Example:**
```typescript
const response = await api.auth(authCode, redirectUri);
auth.setToken(response.token);
console.log('Logged in as:', response.user.email);
```

**Errors:**
- `400 Bad Request`: Invalid code or redirect URI
- `401 Unauthorized`: Google rejected the code
- `500 Internal Server Error`: Backend error

---

### POST /auth/login

Email/password authentication (traditional login).

**Endpoint:** `POST /auth/login`

**Authentication:** Not required

**Request:**
```typescript
{
  email: string;    // User's email
  password: string; // User's password
}
```

**Response:**
```typescript
{
  token: string;  // JWT token
  user: User;     // User object
}
```

**Method:**
```typescript
async login(email: string, password: string): Promise<AuthResponse>
```

**Example:**
```typescript
try {
  const response = await api.login('user@example.com', 'password123');
  auth.setToken(response.token);
} catch (error) {
  console.error('Login failed:', error.message);
}
```

**Errors:**
- `400 Bad Request`: Missing email or password
- `401 Unauthorized`: Invalid credentials
- `500 Internal Server Error`: Backend error

---

### POST /auth/otp/request

Request an OTP code to be sent to the user's email for passwordless login.

**Endpoint:** `POST /auth/otp/request`

**Authentication:** Not required

**Request:**
```typescript
{
  email: string;  // User's email address
}
```

**Response:**
```typescript
{
  message: string;  // Success message
}
```

**Method:**
```typescript
async requestOTP(email: string): Promise<{ message: string }>
```

**Example:**
```typescript
try {
  await api.requestOTP('user@example.com');
  console.log('OTP sent to email');
} catch (error) {
  console.error('Failed to send OTP:', error.message);
}
```

**Errors:**
- `400 Bad Request`: Missing or invalid email
- `429 Too Many Requests`: Too many OTP requests
- `500 Internal Server Error`: Backend error

---

### POST /auth/otp/verify

Verify OTP code and authenticate the user (passwordless login).

**Endpoint:** `POST /auth/otp/verify`

**Authentication:** Not required

**Request:**
```typescript
{
  email: string;  // User's email address
  otp: string;    // 6-digit OTP code
}
```

**Response:**
```typescript
{
  token: string;  // JWT token
  user: User;     // User object
}
```

**Method:**
```typescript
async verifyOTP(email: string, otp: string): Promise<AuthResponse>
```

**Example:**
```typescript
try {
  const response = await api.verifyOTP('user@example.com', '123456');
  auth.setToken(response.token);
  console.log('Logged in via OTP');
} catch (error) {
  console.error('OTP verification failed:', error.message);
}
```

**Errors:**
- `400 Bad Request`: Missing email or OTP
- `401 Unauthorized`: Invalid or expired OTP
- `500 Internal Server Error`: Backend error

---

### GET /auth/me

Get current authenticated user's information.

**Endpoint:** `GET /auth/me`

**Authentication:** Required

**Headers:**
```typescript
{
  Authorization: `Bearer ${token}`
}
```

**Response:**
```typescript
{
  user: User;  // Current user object
}
```

**Method:**
```typescript
async getMe(token: string): Promise<User>
```

**Example:**
```typescript
const token = auth.getToken();
if (token) {
  const user = await api.getMe(token);
  console.log('Current user:', user);
}
```

**Errors:**
- `401 Unauthorized`: Invalid or expired token
- `404 Not Found`: User not found
- `500 Internal Server Error`: Backend error

---

### GET /websites

List all websites owned by the authenticated user.

**Endpoint:** `GET /websites`

**Authentication:** Required

**Headers:**
```typescript
{
  Authorization: `Bearer ${token}`
}
```

**Response:**
```typescript
Website[]  // Array of website objects
```

**Method:**
```typescript
async getWebsites(token: string): Promise<Website[]>
```

**Example:**
```typescript
const token = auth.getToken();
const websites = await api.getWebsites(token!);
console.log(`You have ${websites.length} websites`);
```

**Errors:**
- `401 Unauthorized`: Invalid or expired token
- `500 Internal Server Error`: Backend error

---

### POST /websites

Add a new website to the user's account.

**Endpoint:** `POST /websites`

**Authentication:** Required

**Headers:**
```typescript
{
  Authorization: `Bearer ${token}`,
  'Content-Type': 'application/json'
}
```

**Request:**
```typescript
{
  domain: string;  // Website domain to add
}
```

**Response:**
```typescript
Website  // Newly created website object
```

**Method:**
```typescript
async addWebsite(token: string, domain: string): Promise<Website>
```

**Example:**
```typescript
const token = auth.getToken();
const newWebsite = await api.addWebsite(token!, 'example.com');
console.log('Added website:', newWebsite.id);
```

**Errors:**
- `400 Bad Request`: Invalid domain format or missing domain
- `401 Unauthorized`: Invalid or expired token
- `409 Conflict`: Domain already exists
- `500 Internal Server Error`: Backend error

---

### DELETE /websites/:id

Delete a website from the user's account.

**Endpoint:** `DELETE /websites/:id`

**Authentication:** Required

**Headers:**
```typescript
{
  Authorization: `Bearer ${token}`
}
```

**Parameters:**
- `id` (path): Website ID to delete

**Response:**
- `204 No Content` on success

**Method:**
```typescript
async deleteWebsite(token: string, id: string): Promise<void>
```

**Example:**
```typescript
const token = auth.getToken();
await api.deleteWebsite(token!, websiteId);
console.log('Website deleted successfully');
```

**Errors:**
- `401 Unauthorized`: Invalid or expired token
- `403 Forbidden`: Website doesn't belong to user
- `404 Not Found`: Website not found
- `500 Internal Server Error`: Backend error

## Error Handling

### Error Response Format

All errors return a JSON response:

```typescript
{
  error: string;  // Human-readable error message
}
```

### Error Handling Pattern

```typescript
try {
  const response = await api.someMethod(...);
  // Handle success
} catch (error: any) {
  // Handle error
  console.error('API Error:', error.message);
  // Show user-friendly message
  alert(error.message || 'An error occurred');
}
```

### Common HTTP Status Codes

| Code | Meaning | Description |
|------|---------|-------------|
| 200 | OK | Request succeeded |
| 201 | Created | Resource created successfully |
| 204 | No Content | Deletion successful |
| 400 | Bad Request | Invalid request parameters |
| 401 | Unauthorized | Authentication required or token invalid |
| 403 | Forbidden | Authenticated but not authorized |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Resource already exists |
| 500 | Internal Server Error | Backend error |

## Usage Examples

### Complete Authentication Flow

```typescript
import { api } from '@/lib/api';
import { auth } from '@/lib/auth';

// 1. Google OAuth Login
const handleGoogleLogin = () => {
  const clientId = process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID;
  const redirectUri = process.env.NEXT_PUBLIC_REDIRECT_URI;
  
  const googleAuthUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
  googleAuthUrl.searchParams.append('client_id', clientId || '');
  googleAuthUrl.searchParams.append('redirect_uri', redirectUri || '');
  googleAuthUrl.searchParams.append('response_type', 'code');
  googleAuthUrl.searchParams.append('scope', 'email profile');
  
  window.location.href = googleAuthUrl.toString();
};

// 2. Handle OAuth Callback
const handleCallback = async (code: string) => {
  try {
    const redirectUri = process.env.NEXT_PUBLIC_REDIRECT_URI || '';
    const response = await api.auth(code, redirectUri);
    
    // Store token
    auth.setToken(response.token);
    
    // User is now authenticated
    console.log('Logged in as:', response.user.email);
    
    // Redirect to dashboard
    router.push('/dashboard');
  } catch (error: any) {
    console.error('Authentication failed:', error.message);
  }
};
```

### Dashboard Data Loading

```typescript
import { api } from '@/lib/api';
import { auth } from '@/lib/auth';
import { useState, useEffect } from 'react';

function Dashboard() {
  const [user, setUser] = useState<User | null>(null);
  const [websites, setWebsites] = useState<Website[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const loadData = async () => {
      const token = auth.getToken();
      if (!token) {
        router.push('/login');
        return;
      }

      try {
        // Load user and websites in parallel
        const [userData, websitesData] = await Promise.all([
          api.getMe(token),
          api.getWebsites(token)
        ]);
        
        setUser(userData);
        setWebsites(websitesData);
      } catch (error) {
        console.error('Failed to load data:', error);
        // Token might be expired, logout
        auth.removeToken();
        router.push('/login');
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, []);

  return (
    // ... UI
  );
}
```

### Adding a Website

```typescript
const handleAddWebsite = async (domain: string) => {
  const token = auth.getToken();
  if (!token) return;

  try {
    const newWebsite = await api.addWebsite(token, domain);
    
    // Add to local state
    setWebsites([newWebsite, ...websites]);
    
    // Show success message
    alert('Website added successfully!');
  } catch (error: any) {
    // Show error message
    alert(error.message || 'Failed to add website');
  }
};
```

### Deleting a Website

```typescript
const handleDeleteWebsite = async (websiteId: string) => {
  if (!confirm('Are you sure you want to delete this website?')) {
    return;
  }

  const token = auth.getToken();
  if (!token) return;

  try {
    await api.deleteWebsite(token, websiteId);
    
    // Remove from local state
    setWebsites(websites.filter(w => w.id !== websiteId));
    
    // Show success message
    alert('Website deleted successfully!');
  } catch (error: any) {
    // Show error message
    alert(error.message || 'Failed to delete website');
  }
};
```

### Complete CRUD Example

```typescript
import { api } from '@/lib/api';
import { auth } from '@/lib/auth';

class WebsiteManager {
  // List all websites
  async list(): Promise<Website[]> {
    const token = auth.getToken();
    if (!token) throw new Error('Not authenticated');
    return api.getWebsites(token);
  }

  // Add new website
  async add(domain: string): Promise<Website> {
    const token = auth.getToken();
    if (!token) throw new Error('Not authenticated');
    return api.addWebsite(token, domain);
  }

  // Delete website
  async delete(id: string): Promise<void> {
    const token = auth.getToken();
    if (!token) throw new Error('Not authenticated');
    await api.deleteWebsite(token, id);
  }

  // Get current user
  async getCurrentUser(): Promise<User> {
    const token = auth.getToken();
    if (!token) throw new Error('Not authenticated');
    return api.getMe(token);
  }
}

export const websiteManager = new WebsiteManager();
```

## Best Practices

### 1. Always Check Authentication

```typescript
const token = auth.getToken();
if (!token) {
  router.push('/login');
  return;
}
```

### 2. Handle Errors Gracefully

```typescript
try {
  const data = await api.someMethod(...);
} catch (error: any) {
  // Log for debugging
  console.error('API Error:', error);
  
  // Show user-friendly message
  setError(error.message || 'Something went wrong');
}
```

### 3. Use TypeScript Types

```typescript
import type { User, Website, AuthResponse } from '@/lib/api';

const [user, setUser] = useState<User | null>(null);
const [websites, setWebsites] = useState<Website[]>([]);
```

### 4. Validate Input

```typescript
const handleAddWebsite = async (domain: string) => {
  // Validate domain format
  if (!domain || !/^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?\.[a-zA-Z]{2,}$/.test(domain)) {
    setError('Please enter a valid domain');
    return;
  }
  
  // Proceed with API call
  await api.addWebsite(token, domain);
};
```

### 5. Loading States

```typescript
const [loading, setLoading] = useState(false);

const handleSubmit = async () => {
  setLoading(true);
  try {
    await api.someMethod(...);
  } catch (error) {
    // Handle error
  } finally {
    setLoading(false);
  }
};
```

## Testing

### Mocking API Calls

```typescript
// In tests
jest.mock('@/lib/api', () => ({
  api: {
    auth: jest.fn(),
    getMe: jest.fn(),
    getWebsites: jest.fn(),
    addWebsite: jest.fn(),
    deleteWebsite: jest.fn(),
  }
}));

// Test example
it('loads user data', async () => {
  const mockUser = { id: '1', email: 'test@example.com', name: 'Test', picture: null };
  (api.getMe as jest.Mock).mockResolvedValue(mockUser);
  
  // Test component that uses api.getMe
});
```

## Related Documentation

- [Architecture Overview](ARCHITECTURE.md)
- [Contributing Guide](CONTRIBUTING.md)
- [Backend API Repository](https://github.com/fauzi-rachman/reply-platform-api)
